<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cal Coast Refrigeration — Customer Portal</title>
  <meta name="theme-color" content="#0d3e69" />
  <!-- Favicon (inline SVG) -->
  <link rel="icon" type="image/svg+xml" href='data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"%3E%3Cdefs%3E%3ClinearGradient id="g" x1="0" x2="1" y1="0" y2="1"%3E%3Cstop stop-color="%230d3e69"/%3E%3Cstop stop-color="%23199eff" offset="1"/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect rx="14" ry="14" width="64" height="64" fill="url(%23g)"/%3E%3Cpath d="M20 38c0-6 4-10 12-10s12 4 12 10" fill="none" stroke="white" stroke-width="3" stroke-linecap="round"/%3E%3Ccircle cx="26" cy="28" r="3" fill="white"/%3E%3Ccircle cx="38" cy="28" r="3" fill="white"/%3E%3C/svg%3E' />
  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- MSAL FIRST so sign-in works -->
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js" crossorigin="anonymous"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: { 50:'#eaf2f9',100:'#d3e3f3',200:'#a9c7e6',300:'#7dacd8',400:'#5596cf',500:'#2e7fc6',600:'#195f9f',700:'#124a7c',800:'#0d3e69',900:'#0b2f4f' },
            sky: { 500:'#199eff', 700:'#0d74c3' },
            ink: '#0b1220'
          },
          keyframes: {
            fadeUp: { '0%': {opacity:0, transform:'translateY(12px)'}, '100%': {opacity:1, transform:'translateY(0)'} },
            fade: { '0%': {opacity:0}, '100%': {opacity:1} },
            shimmer: { '0%': { backgroundPosition: '-200% 0' }, '100%': { backgroundPosition: '200% 0' } }
          },
          animation: { fadeUp: 'fadeUp .5s ease-out both', fade: 'fade .4s ease-out both', shimmer: 'shimmer 1.8s linear infinite' },
          boxShadow: { elevate: '0 10px 25px -8px rgba(18, 74, 124, .28)', deep: '0 18px 40px -20px rgba(0,0,0,.35)' }
        }
      }
    }
  </script>
  <style>
    /* Darker, less-bright background */
    body { position: relative; background: radial-gradient(900px 500px at 80% 110%, rgba(13,62,105,.22), transparent 60%), linear-gradient(180deg, #f2f6fa 0%, #eef3f8 40%, #e6edf5 100%); }
    .bg-accent { position: fixed; inset: 0; z-index: -1; pointer-events:none; }
    .bg-accent::before { content:''; position:absolute; top:-8%; left:-6%; width:58%; height:50%; transform:skewY(-6deg); background: linear-gradient(120deg, rgba(46,127,198,.12), rgba(13,62,105,.08)); border-bottom-right-radius:48px; }
    .bg-accent::after { content:''; position:absolute; bottom:-12%; right:-10%; width:62%; height:50%; transform:skewY(6deg); background: radial-gradient(700px 400px at 60% 70%, rgba(13,62,105,.18), transparent 70%); border-top-left-radius:48px; }

    .glass { @apply bg-white/85 backdrop-blur-xl shadow-elevate ring-1 ring-slate-200/70; }
    .btn { @apply inline-flex items-center justify-center rounded-xl px-5 py-2.5 font-semibold transition; }
    .btn-primary { @apply bg-brand-800 text-white hover:bg-brand-700 active:bg-brand-900 shadow-deep ring-1 ring-brand-900/20; }
    .btn-dark { @apply bg-ink text-white hover:bg-slate-800; }
    .chip { @apply text-xs px-2 py-0.5 rounded-full; }

    /* NAV (sticky bar distinctly colored) */
    .sticky-nav { position: sticky; top: 0; z-index: 30; backdrop-filter: saturate(160%) blur(6px); background: rgba(13,62,105,.96); color: white; }
    .sticky-shadow { box-shadow: 0 10px 30px -12px rgba(13,62,105,.45); }
    .navtab { @apply px-6 py-3 rounded-xl text-base font-semibold cursor-pointer transition; }
    .navtab-active { @apply bg-white text-brand-800 shadow; }
    .navtab-inactive { @apply bg-transparent text-white/90 hover:bg-white/10 ring-1 ring-white/20; }
    .nav-divider { width:1px; height:28px; background: rgba(255,255,255,.25); }

    .skeleton { @apply animate-pulse rounded-xl bg-slate-200/70; }
    .shimmer { background: linear-gradient(90deg, rgba(46,127,198,.12) 25%, rgba(46,127,198,.24) 37%, rgba(46,127,198,.12) 63%); background-size: 400% 100%; }
  </style>
</head>
<body class="min-h-screen text-slate-900">
  <div class="bg-accent"></div>
  <!-- Header -->
  <header class="max-w-7xl mx-auto px-6 pt-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <img src="./logo.png" alt="Cal Coast Refrigeration" class="h-20 w-auto drop-shadow" />
        <div class="leading-tight">
          <h1 class="text-3xl sm:text-4xl font-bold text-brand-800">Cal Coast Refrigeration</h1>
          <p class="text-sm text-slate-500">Customer Portal</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span id="userName" class="hidden text-sm text-slate-700"></span>
        <button id="btnSignIn" class="hidden btn navtab-inactive">Sign in</button>
        <button id="btnSignOut" class="hidden btn navtab-inactive">Sign out</button>
      </div>
    </div>
  </header>

  <!-- Hero / Auth Card -->
  <section id="authSection" class="max-w-3xl mx-auto px-6 mt-10 animate-fadeUp">
    <div class="glass rounded-3xl p-8 sm:p-10 relative overflow-hidden">
      <h2 class="text-4xl sm:text-5xl font-extrabold text-center text-brand-800">Cal Coast Refrigeration Customer Portal</h2>
      <p class="text-center text-slate-600 mt-2">Please sign in below</p>

      <div class="mt-8 flex flex-col sm:flex-row items-center justify-center gap-4">
        <button id="linkSignIn" class="btn btn-primary w-full sm:w-auto">Sign in</button>
        <button id="linkCreate" class="btn btn-dark w-full sm:w-auto">Create account</button>
      </div>

      <!-- Soft shimmer skeleton accents -->
      <div id="heroShimmer" class="absolute inset-x-0 bottom-0 translate-y-1/2 px-8 pb-6 pointer-events-none">
        <div class="h-2 rounded-full shimmer animate-shimmer opacity-60"></div>
      </div>

      <div class="mt-4 text-center text-xs text-slate-500 relative z-10">
        Having trouble? <a id="adminOverrideOpen" class="underline cursor-pointer">Admin override</a>
      </div>
    </div>
  </section>

  <!-- App Shell -->
  <section id="appSection" class="hidden max-w-7xl mx-auto px-6 mt-10 mb-16 animate-fade">
    <!-- Sticky sub‑nav (~2/3 width) -->
    <div id="stickyNav" class="sticky-nav rounded-2xl p-3 mb-6 max-w-4xl mx-auto">
      <div class="flex items-center justify-between gap-2">
        <button data-tab="openJobs" class="navtab navtab-active flex-1">Open Jobs</button>
        <div class="nav-divider"></div>
        <button data-tab="pastJobs" class="navtab navtab-inactive flex-1">Past Jobs</button>
        <div class="nav-divider"></div>
        <button data-tab="createCall" class="navtab navtab-inactive flex-1">Create Service Call</button>
        <div class="nav-divider"></div>
        <button data-tab="assets" class="navtab navtab-inactive flex-1">Asset Management</button>
      </div>
    </div>

    <!-- Panels -->
    <div id="panel-openJobs" class="glass rounded-2xl p-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
        <h3 class="text-3xl font-extrabold text-brand-800">Open Jobs</h3>
        <div class="flex gap-2">
          <input id="filterSearch" type="text" placeholder="Search jobs…" class="border rounded-xl px-3 py-2 w-56" />
          <select id="filterStatus" class="border rounded-xl px-3 py-2">
            <option value="">All Statuses</option>
            <option>New</option>
            <option>Scheduled</option>
            <option>In Progress</option>
            <option>On Hold</option>
          </select>
        </div>
      </div>
      <div id="openJobsList" class="grid md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
    </div>

    <div id="panel-pastJobs" class="glass rounded-2xl p-6 hidden">
      <h3 class="text-3xl font-extrabold text-brand-800 mb-4">Past Jobs</h3>
      <div id="pastJobsList" class="grid md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
    </div>

    <div id="panel-createCall" class="glass rounded-2xl p-6 hidden">
      <h3 class="text-3xl font-extrabold text-brand-800 mb-4">Create Service Call</h3>
      <form id="serviceCallForm" class="grid gap-4 max-w-3xl">
        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-1">Contact Name</label>
            <input name="contactName" class="w-full border rounded-xl px-3 py-2" placeholder="Jane Smith" required />
          </div>
          <div>
            <label class="block text-sm mb-1">Contact Email</label>
            <input name="contactEmail" type="email" class="w-full border rounded-xl px-3 py-2" placeholder="jane@example.com" required />
          </div>
        </div>
        <div>
          <label class="block text-sm mb-1">Site / Location</label>
          <input name="site" class="w-full border rounded-xl px-3 py-2" placeholder="e.g., Store #12 - 123 Main St" required />
        </div>

        <!-- Dynamic asset blocks -->
        <div id="assetBlocks" class="grid gap-5"></div>
        <button id="btnAddAsset" type="button" class="btn btn-primary w-max">Add another Asset</button>

        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-1">Priority</label>
            <select name="priority" class="w-full border rounded-xl px-3 py-2" required>
              <option>Low</option>
              <option>Normal</option>
              <option>High</option>
              <option>Emergency</option>
            </select>
          </div>
          <div>
            <label class="block text-sm mb-1">Contact Phone</label>
            <input name="phone" class="w-full border rounded-xl px-3 py-2" placeholder="(555) 123‑4567" required />
          </div>
        </div>
        <button type="submit" class="btn btn-primary w-max">Submit Request</button>
        <p id="submitMsg" class="text-sm text-green-700 hidden">Submitted!</p>
      </form>
    </div>

    <div id="panel-assets" class="glass rounded-2xl p-6 hidden">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-3xl font-extrabold text-brand-800">Asset Management</h3>
        <button id="btnRefreshAssets" class="btn navtab-inactive">Refresh</button>
      </div>
      <div id="assetSummary" class="mb-3 text-slate-700 text-sm"></div>
      <div id="assetsList" class="grid md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="max-w-7xl mx-auto px-6 pb-10 pt-8 text-center text-xs text-slate-500">© <span id="year"></span> Cal Coast Refrigeration</footer>

  <!-- Admin Override Modal (DEMO ONLY) -->
  <div id="adminModal" class="fixed inset-0 hidden items-center justify-center bg-slate-900/50 p-4">
    <div class="glass rounded-2xl p-6 w-full max-w-sm">
      <h4 class="text-lg font-semibold mb-2">Admin Override</h4>
      <p class="text-xs text-slate-500 mb-3">For development/demo only. Bypasses identity and shows the portal. Remove before production.</p>
      <form id="adminForm" class="grid gap-3">
        <div>
          <label class="block text-sm mb-1">Username</label>
          <input id="adminUser" class="w-full border rounded-xl px-3 py-2" placeholder="Username" />
        </div>
        <div>
          <label class="block text-sm mb-1">Password</label>
          <input id="adminPass" type="password" class="w-full border rounded-xl px-3 py-2" placeholder="Password" />
        </div>
        <div class="flex items-center justify-between">
          <button class="btn btn-primary" type="submit">Unlock</button>
          <button class="btn navtab-inactive" type="button" id="adminCancel">Cancel</button>
        </div>
        <p id="adminError" class="hidden text-sm text-red-600">Invalid credentials.</p>
      </form>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const CONFIG = {
      auth: {
        clientId: "YOUR_SPA_CLIENT_ID",
        authority: "https://YOUR_TENANT.b2clogin.com/YOUR_TENANT.onmicrosoft.com/B2C_1_signupsignin",
        knownAuthorities: ["YOUR_TENANT.b2clogin.com"],
        redirectUri: window.location.origin + window.location.pathname,
        cache: { cacheLocation: "localStorage", storeAuthStateInCookie: false },
        scopes: ["api://YOUR_API_APP_ID/Portal.Read", "api://YOUR_API_APP_ID/Portal.Write"]
      },
      apiBase: "https://YOUR-FUNCTION-APP.azurewebsites.net/api"
    };

    // ====== Admin override (DEMO ONLY) ======
    const ADMIN = { user: "EthenPorcho", pass: "Pandamanda1!" };

    // ====== MSAL ======
    const msalInstance = new msal.PublicClientApplication({
      auth: {
        clientId: CONFIG.auth.clientId,
        authority: CONFIG.auth.authority,
        knownAuthorities: CONFIG.auth.knownAuthorities,
        redirectUri: CONFIG.auth.redirectUri,
      },
      cache: CONFIG.auth.cache,
    });

    function getActiveAccount() { const accounts = msalInstance.getAllAccounts(); return accounts[0] || null; }

    async function signIn() { try { await msalInstance.loginPopup({ scopes: CONFIG.auth.scopes }); localStorage.setItem("ccr_portal_logged_in","true"); renderAuthState(); await loadAllData(); } catch(e){ console.error(e); alert("Sign-in failed."); } }
    async function createAccount() { await signIn(); }
    async function signOut(){ try { localStorage.removeItem("ccr_portal_logged_in"); localStorage.removeItem("ccr_admin_override"); await msalInstance.logoutPopup(); } catch(e){ console.error(e);} }

    async function getToken(){ const override = localStorage.getItem("ccr_admin_override") === "true"; if(override) return null; const account = getActiveAccount(); if(!account) throw new Error("No active account"); try{ const r = await msalInstance.acquireTokenSilent({account, scopes: CONFIG.auth.scopes}); return r.accessToken; } catch(e){ const r = await msalInstance.acquireTokenPopup({scopes: CONFIG.auth.scopes}); return r.accessToken; } }

    // ====== API helpers ======
    async function apiGet(path, params={}){ const qs = new URLSearchParams(params).toString(); const override = localStorage.getItem("ccr_admin_override") === "true"; const headers = {}; if(!override){ const token = await getToken(); headers.Authorization = `Bearer ${token}`; } const res = await fetch(`${CONFIG.apiBase}${path}${qs?`?${qs}`:''}`, { headers }); if(!res.ok) throw new Error(await res.text()); return res.json(); }
    async function apiPost(path, body){ const override = localStorage.getItem("ccr_admin_override") === "true"; const headers = { 'Content-Type':'application/json' }; if(!override){ const token = await getToken(); headers.Authorization = `Bearer ${token}`; } const res = await fetch(`${CONFIG.apiBase}${path}`, { method:'POST', headers, body: JSON.stringify(body) }); if(!res.ok) throw new Error(await res.text()); return res.json(); }

    // ====== UI helpers ======
    function renderAuthState(){ const loggedIn = localStorage.getItem("ccr_admin_override")==="true" || (!!getActiveAccount()) || localStorage.getItem("ccr_portal_logged_in")==="true"; document.getElementById('authSection').classList.toggle('hidden', loggedIn); document.getElementById('appSection').classList.toggle('hidden', !loggedIn); document.getElementById('btnSignIn').classList.toggle('hidden', loggedIn); document.getElementById('btnSignOut').classList.toggle('hidden', !loggedIn); const userName = document.getElementById('userName'); if(loggedIn){ const acct = getActiveAccount(); userName.textContent = acct ? (acct.name || acct.username) : (localStorage.getItem('ccr_admin_override')==='true' ? 'Admin Override' : ''); userName.classList.remove('hidden'); } else { userName.classList.add('hidden'); } }

    function switchTab(name){ document.querySelectorAll('[data-tab]').forEach(btn=>{ const active = btn.getAttribute('data-tab')===name; btn.classList.toggle('navtab-active', active); btn.classList.toggle('navtab-inactive', !active); }); document.querySelectorAll('[id^="panel-"]').forEach(p=>p.classList.add('hidden')); const panel = document.getElementById(`panel-${name}`); panel.classList.remove('hidden'); panel.classList.add('animate-fade'); setTimeout(()=>panel.classList.remove('animate-fade'), 400); }

    function badge(status){ const map = { 'New':'bg-slate-100 text-slate-700', 'Scheduled':'bg-brand-100 text-brand-700', 'In Progress':'bg-amber-100 text-amber-700', 'On Hold':'bg-rose-100 text-rose-700', 'Done':'bg-emerald-100 text-emerald-700' }; return map[status] || 'bg-slate-100 text-slate-700'; }
    function jobCard(job){ return `<div class="rounded-2xl bg-white shadow-sm ring-1 ring-slate-200 p-4"><div class="flex items-center justify-between mb-1"><div class="font-semibold">${job.JobNumber||job.JobID}</div><span class="chip ${badge(job.Status)}">${job.Status}</span></div><div class="text-sm text-slate-700">${job.SiteName||''}</div><div class="text-sm text-slate-500 line-clamp-2">${job.ProblemDesc||''}</div><div class="text-xs text-slate-400 mt-2">Scheduled: ${fmtDate(job.ScheduledStart)}</div></div>`; }
    function assetCard(a){ return `<div class="rounded-2xl bg-white shadow-sm ring-1 ring-slate-200 p-4"><div class="flex items-center justify-between mb-1"><div class="font-semibold">${a.Tag||a.Model}</div><div class="text-xs text-slate-500">${a.Make||''} ${a.Model||''}</div></div><div class="text-sm text-slate-600">Serial: ${a.Serial||'-'}</div><div class="text-sm text-slate-600">Site: ${a.SiteName||'-'}</div><div class="text-sm text-slate-600">Lifetime Spend: $${Number(a.LifetimeSpend||0).toFixed(2)}</div></div>`; }
    function fmtDate(d){ try{ return d ? new Date(d).toLocaleString() : '-'; } catch { return d||'-'; } }

    // ====== Sticky sub‑nav shadow ======
    const stickyNav = document.getElementById('stickyNav');
    window.addEventListener('scroll', ()=>{
      const sc = window.scrollY || document.documentElement.scrollTop;
      stickyNav?.classList.toggle('sticky-shadow', sc > 6);
    });

    // ====== Assets searchable dropdown blocks ======
    let assetsCache = [];
    const assetBlocks = [];
    function newBlockId(){ return Math.random().toString(36).slice(2,9); }

    function assetBlockTemplate(id){
      return `
      <div class="asset-block grid gap-2" data-id="${id}">
        <div>
          <label class="block text-sm mb-1">Asset</label>
          <div class="relative">
            <input type="text" class="asset-search w-full border rounded-xl px-3 py-2" placeholder="Search asset by Tag/Model/Site…" autocomplete="off" />
            <input type="hidden" class="asset-id" />
            <div class="asset-menu absolute z-20 left-0 right-0 mt-1 bg-white rounded-xl shadow-deep ring-1 ring-slate-200 max-h-56 overflow-auto hidden"></div>
          </div>
        </div>
        <div>
          <label class="block text-sm mb-1">Issue Description (for this asset)</label>
          <textarea class="asset-issue w-full border rounded-xl px-3 py-2" rows="3" placeholder="Describe the problem" required></textarea>
        </div>
        <div class="flex items-center gap-3">
          <button type="button" class="btn btn-dark btn-remove">Remove</button>
        </div>
      </div>`;
    }

    function attachBlockEvents(block){
      const search = block.querySelector('.asset-search');
      const hidden = block.querySelector('.asset-id');
      const menu = block.querySelector('.asset-menu');

      function renderList(filter=''){
        const q = filter.trim().toLowerCase();
        const items = assetsCache.filter(a=>{
          const label = `${a.Tag||a.Model||''} ${a.Make||''} ${a.Model||''} ${a.Serial||''} ${a.SiteName||''}`.toLowerCase();
          return !q || label.includes(q);
        }).slice(0, 40);
        menu.innerHTML = items.map(a=>`<button type="button" data-id="${a.EquipmentID}" class="w-full text-left px-3 py-2 hover:bg-brand-50">${a.Tag||a.Model||'Asset'}${a.SiteName?` · <span class='text-slate-500'>${a.SiteName}</span>`:''}</button>`).join('') || `<div class='px-3 py-2 text-sm text-slate-500'>No matches</div>`;
        menu.classList.remove('hidden');
        menu.querySelectorAll('button[data-id]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            hidden.value = btn.getAttribute('data-id');
            search.value = btn.textContent.trim();
            menu.classList.add('hidden');
          });
        });
      }
      search.addEventListener('input', ()=>renderList(search.value));
      search.addEventListener('focus', ()=>renderList(search.value));
      document.addEventListener('click', (e)=>{ if(!block.contains(e.target)) menu.classList.add('hidden'); });

      block.querySelector('.btn-remove').addEventListener('click', ()=>{
        block.remove();
      });
    }

    function addAssetBlock(){
      const id = newBlockId();
      const host = document.getElementById('assetBlocks');
      host.insertAdjacentHTML('beforeend', assetBlockTemplate(id));
      attachBlockEvents(host.querySelector(`.asset-block[data-id="${id}"]`));
    }

    // ====== Data loaders ======
    function renderSkeletonCards(el,n=6){ el.innerHTML = Array.from({length:n}).map(()=>'<div class="skeleton h-28"></div>').join(''); }
    async function loadOpenJobs(){ const list=document.getElementById('openJobsList'); renderSkeletonCards(list,6); try{ const search=document.getElementById('filterSearch').value; const status=document.getElementById('filterStatus').value; const data=await apiGet('/jobs',{scope:'open',q:search,status}); list.innerHTML=data.map(jobCard).join('')||'<div class="text-sm text-slate-500">No open jobs found.</div>'; }catch(e){ console.error(e); list.innerHTML='<div class="text-sm text-red-600">Failed to load jobs.</div>'; } }
    async function loadPastJobs(){ const list=document.getElementById('pastJobsList'); renderSkeletonCards(list,6); try{ const data=await apiGet('/jobs',{scope:'past'}); list.innerHTML=data.map(jobCard).join('')||'<div class="text-sm text-slate-500">No past jobs found.</div>'; }catch(e){ console.error(e); list.innerHTML='<div class="text-sm text-red-600">Failed to load past jobs.</div>'; } }
    async function loadAssets(){ const list=document.getElementById('assetsList'); renderSkeletonCards(list,6); try{ const summary=await apiGet('/assets/summary'); document.getElementById('assetSummary').textContent=`Total assets: ${summary.totalAssets||0} • Lifetime spend: $${Number(summary.totalSpend||0).toFixed(2)}`; const data=await apiGet('/assets'); assetsCache = data; list.innerHTML=data.map(assetCard).join('')||'<div class="text-sm text-slate-500">No assets found.</div>'; }catch(e){ console.error(e); list.innerHTML='<div class="text-sm text-red-600">Failed to load assets.</div>'; } }
    async function submitServiceCall(e){
      e.preventDefault();
      const form = e.target;
      const items = Array.from(document.querySelectorAll('.asset-block')).map(b=>({
        assetId: b.querySelector('.asset-id')?.value,
        description: b.querySelector('.asset-issue')?.value?.trim()
      })).filter(x=>x.assetId);
      const payload = {
        contactName: form.contactName.value.trim(),
        contactEmail: form.contactEmail.value.trim(),
        site: form.site.value.trim(),
        priority: form.priority.value,
        phone: form.phone.value.trim(),
        assets: items
      };
      try{
        await apiPost('/service-calls', payload);
        document.getElementById('submitMsg').classList.remove('hidden');
        form.reset();
        document.getElementById('assetBlocks').innerHTML='';
        addAssetBlock();
        setTimeout(()=>document.getElementById('submitMsg').classList.add('hidden'), 3000);
      }catch(e){ console.error(e); alert('Failed to submit.'); }
    }
    async function loadAllData(){ await Promise.all([loadOpenJobs(), loadPastJobs(), loadAssets()]); }

    // ====== Events ======
    document.getElementById('year').textContent = new Date().getFullYear();
    document.getElementById('filterSearch').addEventListener('input', loadOpenJobs);
    document.getElementById('filterStatus').addEventListener('change', loadOpenJobs);
    document.getElementById('serviceCallForm').addEventListener('submit', submitServiceCall);
    document.getElementById('btnAddAsset').addEventListener('click', addAssetBlock);
    document.querySelectorAll('[data-tab]').forEach(btn=>btn.addEventListener('click',()=>switchTab(btn.getAttribute('data-tab'))));
    document.getElementById('linkSignIn').addEventListener('click',(e)=>{ e.preventDefault(); signIn(); });
    document.getElementById('linkCreate').addEventListener('click',(e)=>{ e.preventDefault(); createAccount(); });
    document.getElementById('btnSignIn').addEventListener('click', signIn);
    document.getElementById('btnSignOut').addEventListener('click', signOut);

    // Admin override modal
    const modal=document.getElementById('adminModal');
    document.getElementById('adminOverrideOpen').addEventListener('click',()=>modal.classList.remove('hidden'));
    document.getElementById('adminCancel').addEventListener('click',()=>modal.classList.add('hidden'));
    document.getElementById('adminForm').addEventListener('submit',(e)=>{ e.preventDefault(); const u=document.getElementById('adminUser').value.trim(); const p=document.getElementById('adminPass').value; if(u==='EthenPorcho'&&p==='Pandamanda1!'){ localStorage.setItem('ccr_admin_override','true'); modal.classList.add('hidden'); renderAuthState(); loadAllData(); } else { document.getElementById('adminError').classList.remove('hidden'); } });

    // Initial auth/UI state + hide hero shimmer soon
    (async()=>{ try{ await msalInstance.handleRedirectPromise(); }catch{} renderAuthState(); if(getActiveAccount() || localStorage.getItem('ccr_admin_override')==='true') { loadAllData(); } addAssetBlock(); setTimeout(()=>{ document.getElementById('heroShimmer')?.classList.add('hidden'); }, 1400); })();
  </script>
</body>
</html>
