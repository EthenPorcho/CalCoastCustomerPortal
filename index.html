<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cal Coast Refrigeration — Customer Portal</title>
  <meta name="theme-color" content="#0ea5e9" />
  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              200: '#bae6fd',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9', // light logo blue
              600: '#0284c7',
              700: '#0369a1', // deep logo blue
              800: '#075985',
              900: '#0c4a6e'
            }
          }
        }
      }
    }
  </script>
  <style>
    /* Subtle background pattern + gradient */
    body::before {
      content: "";
      position: fixed; inset: 0; z-index: -1;
      background: radial-gradient(1200px 600px at 10% 0%, rgba(14,165,233,.15), transparent 60%),
                  radial-gradient(1200px 600px at 90% 20%, rgba(3,105,161,.20), transparent 60%),
                  linear-gradient(180deg, #f8fafc, #eef6fb 30%, #e6f3fb 100%);
    }
    .glass { @apply bg-white/70 backdrop-blur-xl shadow-xl ring-1 ring-slate-200/60; }
    .btn { @apply inline-flex items-center justify-center rounded-xl px-5 py-2.5 font-semibold transition; }
    .btn-primary { @apply bg-brand-600 text-white hover:bg-brand-700 active:bg-brand-800; }
    .btn-dark { @apply bg-slate-900 text-white hover:bg-slate-800; }
    .chip { @apply text-xs px-2 py-0.5 rounded-full; }
    .navtab { @apply px-4 py-2 rounded-full text-sm font-medium cursor-pointer transition; }
    .navtab-active { @apply bg-brand-600 text-white shadow; }
    .navtab-inactive { @apply bg-white/70 text-slate-700 hover:bg-slate-100 ring-1 ring-slate-200; }
  </style>
</head>
<body class="min-h-screen text-slate-900">
  <!-- Header -->
  <header class="max-w-7xl mx-auto px-6 pt-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="./logo.png" alt="Cal Coast Refrigeration" class="h-12 w-auto drop-shadow" />
        <div class="leading-tight">
          <h1 class="text-2xl sm:text-3xl font-bold text-brand-800">Cal Coast Refrigeration</h1>
          <p class="text-sm text-slate-500">Customer Portal</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span id="userName" class="hidden text-sm text-slate-600"></span>
        <button id="btnSignIn" class="hidden btn navtab-inactive">Sign in</button>
        <button id="btnSignOut" class="hidden btn navtab-inactive">Sign out</button>
      </div>
    </div>
  </header>

  <!-- Hero / Auth Card -->
  <section id="authSection" class="max-w-3xl mx-auto px-6 mt-10">
    <div class="glass rounded-3xl p-8 sm:p-10">
      <h2 class="text-3xl sm:text-4xl font-extrabold text-center text-brand-800">Cal Coast Refrigeration Customer Portal</h2>
      <p class="text-center text-slate-600 mt-2">Please sign in below</p>

      <div class="mt-8 flex flex-col sm:flex-row items-center justify-center gap-4">
        <a id="linkSignIn" href="#" class="btn btn-primary w-full sm:w-auto">Sign in</a>
        <a id="linkCreate" href="#" class="btn btn-dark w-full sm:w-auto">Create account</a>
      </div>

      <div class="mt-4 text-center text-xs text-slate-500">
        Having trouble? <a id="adminOverrideOpen" class="underline cursor-pointer">Admin override</a>
      </div>
    </div>
  </section>

  <!-- App Shell -->
  <section id="appSection" class="hidden max-w-7xl mx-auto px-6 mt-10 mb-16">
    <!-- Tabs -->
    <div class="flex flex-wrap gap-2 mb-5">
      <button data-tab="openJobs" class="navtab navtab-active">Open Jobs</button>
      <button data-tab="pastJobs" class="navtab navtab-inactive">Past Jobs</button>
      <button data-tab="createCall" class="navtab navtab-inactive">Create Service Call</button>
      <button data-tab="assets" class="navtab navtab-inactive">Asset Management</button>
    </div>

    <!-- Panels -->
    <div id="panel-openJobs" class="glass rounded-2xl p-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
        <h3 class="text-xl font-semibold">Open Jobs</h3>
        <div class="flex gap-2">
          <input id="filterSearch" type="text" placeholder="Search jobs…" class="border rounded-xl px-3 py-2 w-56" />
          <select id="filterStatus" class="border rounded-xl px-3 py-2">
            <option value="">All Statuses</option>
            <option>New</option>
            <option>Scheduled</option>
            <option>In Progress</option>
            <option>On Hold</option>
          </select>
        </div>
      </div>
      <div id="openJobsList" class="grid md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
    </div>

    <div id="panel-pastJobs" class="glass rounded-2xl p-6 hidden">
      <h3 class="text-xl font-semibold mb-4">Past Jobs</h3>
      <div id="pastJobsList" class="grid md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
    </div>

    <div id="panel-createCall" class="glass rounded-2xl p-6 hidden">
      <h3 class="text-xl font-semibold mb-4">Create Service Call</h3>
      <form id="serviceCallForm" class="grid gap-4 max-w-2xl">
        <div>
          <label class="block text-sm mb-1">Site / Location</label>
          <input name="site" class="w-full border rounded-xl px-3 py-2" placeholder="e.g., Store #12 - 123 Main St" required />
        </div>
        <div>
          <label class="block text-sm mb-1">Issue Description</label>
          <textarea name="description" class="w-full border rounded-xl px-3 py-2" rows="4" placeholder="Describe the problem" required></textarea>
        </div>
        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-1">Priority</label>
            <select name="priority" class="w-full border rounded-xl px-3 py-2" required>
              <option>Low</option>
              <option>Normal</option>
              <option>High</option>
              <option>Emergency</option>
            </select>
          </div>
          <div>
            <label class="block text-sm mb-1">Contact Phone</label>
            <input name="phone" class="w-full border rounded-xl px-3 py-2" placeholder="(555) 123‑4567" required />
          </div>
        </div>
        <button class="btn btn-primary w-max">Submit Request</button>
        <p id="submitMsg" class="text-sm text-green-700 hidden">Submitted!</p>
      </form>
    </div>

    <div id="panel-assets" class="glass rounded-2xl p-6 hidden">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold">Asset Management</h3>
        <button id="btnRefreshAssets" class="btn navtab-inactive">Refresh</button>
      </div>
      <div id="assetSummary" class="mb-3 text-slate-700 text-sm"></div>
      <div id="assetsList" class="grid md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="max-w-7xl mx-auto px-6 pb-10 pt-8 text-center text-xs text-slate-500">© <span id="year"></span> Cal Coast Refrigeration</footer>

  <!-- Admin Override Modal (DEMO ONLY) -->
  <div id="adminModal" class="fixed inset-0 hidden items-center justify-center bg-slate-900/50 p-4">
    <div class="glass rounded-2xl p-6 w-full max-w-sm">
      <h4 class="text-lg font-semibold mb-2">Admin Override</h4>
      <p class="text-xs text-slate-500 mb-3">For development/demo only. Bypasses identity and shows the portal. Remove before production.</p>
      <form id="adminForm" class="grid gap-3">
        <div>
          <label class="block text-sm mb-1">Username</label>
          <input id="adminUser" class="w-full border rounded-xl px-3 py-2" placeholder="Username" />
        </div>
        <div>
          <label class="block text-sm mb-1">Password</label>
          <input id="adminPass" type="password" class="w-full border rounded-xl px-3 py-2" placeholder="Password" />
        </div>
        <div class="flex items-center justify-between">
          <button class="btn btn-primary" type="submit">Unlock</button>
          <button class="btn navtab-inactive" type="button" id="adminCancel">Cancel</button>
        </div>
        <p id="adminError" class="hidden text-sm text-red-600">Invalid credentials.</p>
      </form>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const CONFIG = {
      auth: {
        clientId: "YOUR_SPA_CLIENT_ID",
        authority: "https://YOUR_TENANT.b2clogin.com/YOUR_TENANT.onmicrosoft.com/B2C_1_signupsignin",
        knownAuthorities: ["YOUR_TENANT.b2clogin.com"],
        redirectUri: window.location.origin + window.location.pathname,
        cache: { cacheLocation: "localStorage", storeAuthStateInCookie: false },
        scopes: ["api://YOUR_API_APP_ID/Portal.Read", "api://YOUR_API_APP_ID/Portal.Write"]
      },
      apiBase: "https://YOUR-FUNCTION-APP.azurewebsites.net/api"
    };

    // ====== Admin override (DEMO ONLY) ======
    const ADMIN = { user: "EthenPorcho", pass: "Pandamanda1!" };

    // ====== MSAL ======
    const msalLoaded = typeof msal !== 'undefined';
    const msalInstance = msalLoaded ? new msal.PublicClientApplication({
      auth: {
        clientId: CONFIG.auth.clientId,
        authority: CONFIG.auth.authority,
        knownAuthorities: CONFIG.auth.knownAuthorities,
        redirectUri: CONFIG.auth.redirectUri,
      },
      cache: CONFIG.auth.cache,
    }) : null;

    function getActiveAccount() {
      if (!msalInstance) return null;
      const accounts = msalInstance.getAllAccounts();
      return accounts[0] || null;
    }

    async function signIn() {
      if (!msalInstance) return;
      try {
        const loginResponse = await msalInstance.loginPopup({ scopes: CONFIG.auth.scopes });
        localStorage.setItem("ccr_portal_logged_in", "true");
        renderAuthState();
        await loadAllData();
      } catch (e) { console.error(e); alert("Sign-in failed."); }
    }
    async function createAccount() { await signIn(); }
    async function signOut() {
      try {
        localStorage.removeItem("ccr_portal_logged_in");
        localStorage.removeItem("ccr_admin_override");
        if (msalInstance) await msalInstance.logoutPopup();
      } catch (e) { console.error(e); }
    }

    async function getToken() {
      const override = localStorage.getItem("ccr_admin_override") === "true";
      if (override) return null; // bypass token on override (API must allow anonymous or demo data)
      const account = getActiveAccount();
      if (!account) throw new Error("No active account");
      try {
        const result = await msalInstance.acquireTokenSilent({ account, scopes: CONFIG.auth.scopes });
        return result.accessToken;
      } catch (e) {
        const result = await msalInstance.acquireTokenPopup({ scopes: CONFIG.auth.scopes });
        return result.accessToken;
      }
    }

    // ====== API helpers ======
    async function apiGet(path, params = {}) {
      const qs = new URLSearchParams(params).toString();
      const override = localStorage.getItem("ccr_admin_override") === "true";
      const headers = {};
      if (!override) {
        const token = await getToken();
        headers.Authorization = `Bearer ${token}`;
      }
      const res = await fetch(`${CONFIG.apiBase}${path}${qs ? `?${qs}` : ''}`, { headers });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }
    async function apiPost(path, body) {
      const override = localStorage.getItem("ccr_admin_override") === "true";
      const headers = { 'Content-Type': 'application/json' };
      if (!override) {
        const token = await getToken();
        headers.Authorization = `Bearer ${token}`;
      }
      const res = await fetch(`${CONFIG.apiBase}${path}`, { method: 'POST', headers, body: JSON.stringify(body) });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    // ====== UI helpers ======
    function renderAuthState() {
      const loggedIn = localStorage.getItem("ccr_admin_override") === "true" || (!!getActiveAccount()) || localStorage.getItem("ccr_portal_logged_in") === "true";
      document.getElementById('authSection').classList.toggle('hidden', loggedIn);
      document.getElementById('appSection').classList.toggle('hidden', !loggedIn);

      document.getElementById('btnSignIn').classList.toggle('hidden', loggedIn);
      document.getElementById('btnSignOut').classList.toggle('hidden', !loggedIn);

      const userName = document.getElementById('userName');
      if (loggedIn) {
        const acct = getActiveAccount();
        userName.textContent = acct ? (acct.name || acct.username) : (localStorage.getItem("ccr_admin_override") === 'true' ? 'Admin Override' : '');
        userName.classList.remove('hidden');
      } else {
        userName.classList.add('hidden');
      }
    }

    function switchTab(name) {
      document.querySelectorAll('[data-tab]').forEach(btn => {
        const active = btn.getAttribute('data-tab') === name;
        btn.classList.toggle('navtab-active', active);
        btn.classList.toggle('navtab-inactive', !active);
      });
      document.querySelectorAll('[id^="panel-"]').forEach(p => p.classList.add('hidden'));
      document.getElementById(`panel-${name}`).classList.remove('hidden');
    }

    function badge(status) {
      const map = {
        'New': 'bg-slate-100 text-slate-700',
        'Scheduled': 'bg-brand-100 text-brand-700',
        'In Progress': 'bg-amber-100 text-amber-700',
        'On Hold': 'bg-rose-100 text-rose-700',
        'Done': 'bg-emerald-100 text-emerald-700'
      };
      return map[status] || 'bg-slate-100 text-slate-700';
    }

    function jobCard(job) {
      return `
        <div class="rounded-2xl bg-white shadow-sm ring-1 ring-slate-200 p-4">
          <div class="flex items-center justify-between mb-1">
            <div class="font-semibold">${job.JobNumber || job.JobID}</div>
            <span class="chip ${badge(job.Status)}">${job.Status}</span>
          </div>
          <div class="text-sm text-slate-700">${job.SiteName || ''}</div>
          <div class="text-sm text-slate-500 line-clamp-2">${job.ProblemDesc || ''}</div>
          <div class="text-xs text-slate-400 mt-2">Scheduled: ${fmtDate(job.ScheduledStart)}</div>
        </div>`;
    }

    function assetCard(a) {
      return `
        <div class="rounded-2xl bg-white shadow-sm ring-1 ring-slate-200 p-4">
          <div class="flex items-center justify-between mb-1">
            <div class="font-semibold">${a.Tag || a.Model}</div>
            <div class="text-xs text-slate-500">${a.Make || ''} ${a.Model || ''}</div>
          </div>
          <div class="text-sm text-slate-600">Serial: ${a.Serial || '-'}</div>
          <div class="text-sm text-slate-600">Site: ${a.SiteName || '-'}</div>
          <div class="text-sm text-slate-600">Lifetime Spend: $${Number(a.LifetimeSpend || 0).toFixed(2)}</div>
        </div>`;
    }

    function fmtDate(d) { try { return d ? new Date(d).toLocaleString() : '-'; } catch { return d || '-'; } }

    // ====== Data loaders ======
    async function loadOpenJobs() {
      const list = document.getElementById('openJobsList');
      list.innerHTML = '<div class="text-sm text-slate-500">Loading…</div>';
      try {
        const search = document.getElementById('filterSearch').value;
        const status = document.getElementById('filterStatus').value;
        const data = await apiGet('/jobs', { scope: 'open', q: search, status });
        list.innerHTML = data.map(jobCard).join('') || '<div class="text-sm text-slate-500">No open jobs found.</div>';
      } catch (e) { console.error(e); list.innerHTML = '<div class="text-sm text-red-600">Failed to load jobs.</div>'; }
    }
    async function loadPastJobs() {
      const list = document.getElementById('pastJobsList');
      list.innerHTML = '<div class="text-sm text-slate-500">Loading…</div>';
      try {
        const data = await apiGet('/jobs', { scope: 'past' });
        list.innerHTML = data.map(jobCard).join('') || '<div class="text-sm text-slate-500">No past jobs found.</div>';
      } catch (e) { console.error(e); list.innerHTML = '<div class="text-sm text-red-600">Failed to load past jobs.</div>'; }
    }
    async function loadAssets() {
      const list = document.getElementById('assetsList');
      list.innerHTML = '<div class="text-sm text-slate-500">Loading…</div>';
      try {
        const summary = await apiGet('/assets/summary');
        document.getElementById('assetSummary').textContent = `Total assets: ${summary.totalAssets || 0} • Lifetime spend: $${Number(summary.totalSpend || 0).toFixed(2)}`;
        const data = await apiGet('/assets');
        list.innerHTML = data.map(assetCard).join('') || '<div class="text-sm text-slate-500">No assets found.</div>';
      } catch (e) { console.error(e); list.innerHTML = '<div class="text-sm text-red-600">Failed to load assets.</div>'; }
    }
    async function submitServiceCall(e) {
      e.preventDefault();
      const form = e.target;
      const payload = { site: form.site.value.trim(), description: form.description.value.trim(), priority: form.priority.value, phone: form.phone.value.trim() };
      try { await apiPost('/service-calls', payload); document.getElementById('submitMsg').classList.remove('hidden'); form.reset(); setTimeout(()=>document.getElementById('submitMsg').classList.add('hidden'), 3000); }
      catch (e) { console.error(e); alert('Failed to submit.'); }
    }
    async function loadAllData() { await Promise.all([loadOpenJobs(), loadPastJobs(), loadAssets()]); }

    // ====== Events ======
    document.getElementById('year').textContent = new Date().getFullYear();
    document.getElementById('filterSearch').addEventListener('input', loadOpenJobs);
    document.getElementById('filterStatus').addEventListener('change', loadOpenJobs);
    document.getElementById('serviceCallForm').addEventListener('submit', submitServiceCall);
    document.querySelectorAll('[data-tab]').forEach(btn => btn.addEventListener('click', () => switchTab(btn.getAttribute('data-tab'))));

    document.getElementById('linkSignIn').addEventListener('click', (e) => { e.preventDefault(); signIn(); });
    document.getElementById('linkCreate').addEventListener('click', (e) => { e.preventDefault(); createAccount(); });
    document.getElementById('btnSignIn').addEventListener('click', signIn);
    document.getElementById('btnSignOut').addEventListener('click', signOut);

    // Admin override modal
    const modal = document.getElementById('adminModal');
    document.getElementById('adminOverrideOpen').addEventListener('click', () => modal.classList.remove('hidden'));
    document.getElementById('adminCancel').addEventListener('click', () => modal.classList.add('hidden'));
    document.getElementById('adminForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const u = document.getElementById('adminUser').value.trim();
      const p = document.getElementById('adminPass').value;
      if (u === ADMIN.user && p === ADMIN.pass) {
        localStorage.setItem('ccr_admin_override','true');
        modal.classList.add('hidden');
        renderAuthState();
        loadAllData();
      } else {
        document.getElementById('adminError').classList.remove('hidden');
      }
    });

    // Initial auth/UI state
    (async () => {
      try { if (msalInstance) await msalInstance.handleRedirectPromise(); } catch {}
      renderAuthState();
      if (getActiveAccount() || localStorage.getItem('ccr_admin_override')==='true') loadAllData();
    })();
  </script>
  <!-- MSAL (deferred load for better FCP) -->
  <script defer src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js" integrity="sha384-TBYk1qP5I9M9YqXg0hZ0E2WxbQZ6b1ySAGc7bX0C7n0H+u7jR0kR9cGm1o8rU4sJ" crossorigin="anonymous"></script>
</body>
</html>
  </script>
</body>
</html>
